# LLM Billing Proxy

HTTP proxy that sits between end users and LLM servers and bills them per token.

## Requirements

* aiohttp ~= 3.9.3
* motor ~= 3.5
* Mongo database (CGC-compatible, see section *Database* below)

## Configuration

See [config.toml](config.toml) for an example configuration file.
The program will update the list of configured backends from the config file
on SIGHUP.

```sh
pkill -f -HUP 'python3? .*llm-billing-proxy\.py'

# or in Docker
docker kill -s=SIGHUP CONTAINER
```

## Development

Edit `config.toml` and configure backends.

Populate a Mongo database with sample API keys.

```sh
cat sample.js | mongosh
```

Run the proxy.

```sh
python3 llm-billing-proxy.py
```

Then, run a query.

```sh
curl -v -H'Content-Type: application/json' -H'Authorization: Bearer token2' \
    -d'{"messages": [{"role": "system", "content": "You are an assistant."}, {"role": "user", "content": "Write a limerick about python exceptions"}], "model": "llama31-70b", "stream": true}' \
    'http://localhost:8080/v1/chat/completions'
```

## Docker

```sh
docker build -t llm-billing-proxy .
docker run 
```
## Database

This program uses MongoDB for authentication and completion logging.
The schema is compatible with Comtergra GPU Core.

## Authentication

Users authenticate via bearer tokens.
Tokens are stored in the database as SHA256 hashes.
They can be generated by the following command:

```sh
python3 -c 'import hashlib, secrets; print("Token:", t:=secrets.token_urlsafe(64)); print("Hash:", hashlib.sha256(t.encode()).hexdigest())'
```

When a user attempts to authenticate, the following query is performed to the
`cgc.api_keys` collection.

```js
{
    "access_level": "COMPLETION",
    "secret": TOKEN-HASH,
    "$or": [
        {"date_expiry": {"$gt": new Date()}},
        {"date_expiry": null},
    ],
}
```

`TOKEN-HASH` is replaced with the SHA256 hash of the bearer token.

The documents are required to have an additional field: `user_id`.

## Completion logging

When a user performs a completion, a completion event is inserted into the
collection `billing.events_completion`.
These documents have the following fields:

* `date_created` -- date and time when the request finished processing
* `user_id` -- `user_id` of the API key
* `api_key_id` -- id of the API key
* `model` -- name of the model used for completion
* `prompt_n` -- prompt token count
* `completion_n` -- completion token count
